# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/base/ — папка с базовым кодом
- src/components/common/ — папка с общим кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами данных
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды для установки зависимости и запуска проекта в режиме разработки, соответственно.

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка
Для сборки проекта в продакшн необходимо выполнить команду сборки в режиме разработки.\
Для данного проекта нет ограничений по использованию пакетного менеджера, поэтому можно использовать также YARN или PNPM.

```
npm run build
```

или

```
yarn build
```
## Данные и их типы, используемые в проекте

### Интерфейсы данных 
1. Карточка товара.
Данный интерфейс описывает получаемые данные с сервера, которые будут создавать карточку товара в приложении.

```
interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
  selected: boolean;
}
```
2. Данные пользователя.
Данный интерфейс описывает получаемые данные пользователя, при заполнений формы, и массив оформленных карточек вместе с общей суммой заказа.

```
interface ICustomer { 
  payment: string;
  address: string;
  email: string;
  phone: string;
  items: string[];
  total: number;
}
```
3. Интерфейс для хранения списка товаров и общей суммы заказа.
```
interface IBasket {
	items: HTMLElement[];
	totalCost: number;
}
```
4. Интерфейс для хранения идентификатора созданного заказа и количество списанной валюты.
```
interface IOrderResult {
  total: number;
}
```
5. Интерфейс для получение карточек с сервера, их вывода на страницу. Добавления и удаления карточек из корзины. Работу валидации формы и обновление данных.
```
interface IAppData {
  basket: IProduct[];
  products: IProduct[];
  customerOrder: ICustomer;
  formErrors: Partial<Record<keyof CustomerForm, string>>;
  addToBasket(product: IProduct): void;
  removeFromBasket(product: IProduct): void;
  clearBasket(): void;
  getBasketAmount(): number;
  setItems(): void;
  setOrderField(field: keyof CustomerForm, value: string): void;
  validateContacts(): boolean;
  validateOrder(): boolean;
  updateOrder(): boolean;
  setStore(items: IProduct[]): void;
  resetSelected(): void;
}
```
6. Интерфейс предназначен для получения данных, чтобы в дальнейшем по ним производить запрос на сервер.
```
interface IApi {
  baseUrl: string;
  get<T>(uri: string): Promise<T>;
  post(uri: string, data: object): Promise<object>;
}
```
7. Интерфейс предназначен формирования модального окна.
```
interface IModalData {
	content: HTMLElement;
}
```

### Типы данных компонентов приложения

1. Именованый тип для валидации полей ввода.
```
type CustomerForm = Omit<iCustomer, 'items' | 'total'>;
```
2. Именованый тип для проверки валидации способа оплаты и адреса.
```
type CustomerOrder = Pick<ICustomer, 'payment' | 'address'>;
```
3. Именованый тип для проверки валидации почты и телефона.
```
type CustomerContacts = Pick<ICustomer, 'email' | 'phone'>;
```
4. Метода для взаимодействия с сервером.
```
type ApiPostMethods = 'POST' | 'PUT';
```
5. Именованый тип для хранения ошибок валидации.
```
type FormErrors = Partial<Record<keyof CustomerForm, string>>;
```

## Архитектура приложения

Код приложения разделен на три слоя (и один дополнительный), согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице;
- слой данных, отвечает за хранение и изменение данных;
- коммуникационный слой, отвечает за связь с бэкендом.
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику запросов. Данные принимаются с сервера по именованному типу ApiListResponse<Type>. Метода класса выполняются ассинхронно.  В конструктор передается базовый адрес сервера и опциональный объект с загаловками запросов. 
- `constructor(baseUrl: string, options: RequestInit = {})`

Полу класса:
- baseUrl: string - базовый URL для всех запросов, доступный только для чтения;
- options: RequestInit - глобальные опции для всех запросов.

Методы: 
- `handleResponse<T>(response: Response): Promise<T>` - обрабатывает ответ от сервера.
- `get<T>(uri: string)` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер;
- `post<T>(uri: string, data: object)` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт, переданный как параметр при вызове метода. Выполняется 'POST'-запрос.

#### Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. Содержит в себе общий конструктор, который принимает в себя дженерик и контейнер DOM-элемента, являющийся основным родительским контейнером компонента, и метод `render` для отображения всех карточек на странице, полученных в полях компонентов через их сеттеры, загружая их разметку в нужный контейнер, и возвращая обновлненный контейнер компонента. В дженерик принимается тип объекта, в котором данные будут передаватьсяв метод `render` для отображения данных в компоненте. Так же он имеет еще несколько базовых методов для работы со слоем представления. \
Методы класса:
- toggleClass(element: HTMLElement, className: string, force?: boolean) - позволяющий переключить класс элемента разметки;
- setText(element: HTMLElement, value: unknown) - позволяющий установить текстовое содержимое элемента разметки;
- setDisabled(element: HTMLElement, state: boolean) - позволяющий сменить статус блокировки элемента кнопки разметки;
- setHidden(element: HTMLElement) - позволяющий скрыть элемент разметки;
- setVisible(element: HTMLElement) - позволяющий показать элемент разметки;
- setImage(element: HTMLImageElement, src: string, alt?: string) - позволяющий установить изображение с алтернативным текстом;
- render(data?: Partial<T>): HTMLElement - заполняет атрибуты элементов карточки данными с помощью сеттеров для каждого свойства объекта карточки и выводит карточку на страницу вместе с установленными слушателями событий, установленными на все интерактивные элементы карточки, что позволит генерировать соответствующие события через экземпляр брокера событий.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презенторе для обработки событий и в слоях приложения для генерации событий. Дополнительно имеет набор type alias для правильной типизации данных, а также интерфейс `IEvents`.\
Конструктор создает коллекцию с указанием типов для ключей и их значений.
- `this._events = new Map<EventName, Set<Subscriber>>()` - принимает название события и уникального обработчика события.

Основные методы, реализуемые класс описаны интерфейсом `IEvents`:
- `on<T extends object>(eventName: EventName, callback: (event: T) => void)` - подписка на события. Принимает название события и функциб коллбэка для обработки события с обобщенным типом;
- `emit<T extends object>(eventName: string, data?: T)` - инициализация события. Принимает название события и данные для инициализации события с обобщенным типом;
Дополнительные методы класса:
- off(eventName: EventName, callback: Subscriber) - снятие обработчика с события;
- onAll(callback: (event: EmitterEvent) => void) - подписка на все события;
- offAll() - сбросить все обработчики.

### Слой данных

#### Класс Model 
Базовый класс работы с данными, отвечает за хранение данных и обработку событий. Реализаует вызов метода `emitChanges` при изменении данных.\

#### Класс AppData
Класс отвечает за хранение данных карточек и проверку валидации полей формы, заполняемых пользователем перед оформлением заказа. Содержит данные о продуктах, состояния корзины, предварительный просмотре выбранной карточки. Он имеет методы для управления карточками в корзине и взаимодействия с ними через события. Так же содержит в себе дополнительный класс `Product` для вывода карточек на страницу, который наследует класс `Model` для инициирования события загрузки данных с сервера.\

В полях класса хранятся следующие данные:
- basket: IProduct[] - массив объектов карточек корзины (изначально пустой); 
- products: IProduct[] - массив объектов карточек продуктов;
- customerOrder: ICustomer - массив данных пользователя (изначально пустой);
- formErrors: FormErrors - объект с ошибками формы (изначально пустой);

Так же класс имеет набор методов для взаимодействия с этими данными:
- addToBasket(value: IProduct) - добавляет выбранную карточку в корзину покупок;
- deleteFromBasket(id: string) - удаляет выбранную карточку из корзины покупок;
- clearBasket() - очищает корзину покупок;
- getBasketAmount() - возвращает общую сумму карточек в корзине покупок;
- setItems() - устанавливает массив карточек продуктов;
- setOrderField(field: keyof CustomerForm, value: string) - устанавливает значение полей формы выбора оплаты и личных данных;
- validateContacts() - проверяет валидность полей формы;
- validateOrder() - проверяет валидность полей формы;
- updateOrder() - обновляет данные заказа, например, после оформления заказа;
- getTotalBasketPrice() - возвращает общую сумму карточек в корзине покупок;
- setProducts(items: IProduct[]) - устанавливает массив карточек продуктов на страницу после успешного ответа от сервера;
- resetSelected() - сбрасывает состояние выбранной карточки.

### Слой представления
Классы этого слоя отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.\

#### Класс Modal
Реализует модальное окно. Так же предоставляет метода `open` и `close` для управления отображением модального окна.  Устанавливает слушатели на клавиатуру, для закрытия модального окна по нажатию клавиши Esc, на клик в оверлей вне модального окна и кнопку-крестик для закрытия модального окна.

- `constructor(container: HTMLElement, protected events: IEvents)` - конструктор принимает в качестве параметров селектор, по которому в разметке страницы будет идентифицировано модальное окно и обработчик, реализующий интерфейс `IEvents` для возможности инициации событий с модальными окнами.

Поля класса:
- _content: HTMLElement - DOM-элемент модального окна;
- _closeButton: HTMLButtonElement - DOM-элемент кнопки закрытия модального окна;

Методы класса:
- сеттер content(value: HTMLElement) - задает разметку с данными для модального окна;
- open() - открывает модальное окно, создает слушатель на клавишу Esc и создает событие `modal:open`;
- close() - закрывает модальное окно, удаляет слушатель на клавишу Esc и создает событие `modal:close`;
- handleKeyDown - метод, закрывающий модальное окно по нажатию клавиши Esc;
- render(data: IModalData): HTMLElement - метод отображения модального окна, который наследует родительский рендер с данными разметки.

#### Класс FormDataValid
Общий класс, отвечающий за валидацию полей формы. В нем реализовывается проверка ввода данных пользователем. Класс наследует метод `render` для отображения данных от класса Component и container DOM-элемента формы, реализуемый интерфейсом `iFormDataValidState`.\
Конструктор класса принимает контейнер инпута формы и инстант брокера событий. Вешает обработчик на изменение данных в полях формы и сабмит.
- `constructor(protected container: HTMLFormElement, protected events: IEvents)`.
Поля класса:
- _submitButton: HTMLButtonElement - DOM-элемент кнопки;
- _errorsData: HTMLElement - DOM-элемент для отображения ошибок;

Методы класса:
- onInputChange(field: keyof T, value: string) - защищенный метод, вызывается при изменении значения полей формы;
- сеттеры valid и errors сохраняют данные в поля;
- render(state: Partial<T> & iFormDataValidState) - метод отображает состояние компонента.

#### Класс UserContactDetails
Класс отвечает за установку данных через поля ввода пользователем для оформления заказа и их валидацию. Является наследником FormDataValid, реализуемым алиесом `CustomerContacts`. Наследует метод `render`, контейнер DOM-элемента формы и инстант брокера событий.
- `constructor(container: HTMLFormElement, events: IEvents)` - конструктор принимает DOM-элемент формы, наследуемый от родителя, и инстант брокера событий, для отслеживания валидности поля.
Поля класса: 
- email: HTMLInputElement - DOM-элемент для ввода почты;
- phone: HTMLInputElement - DOM-элемент для ввода телефона;

Методы класса:
- сеттеры email и phone сохраняют данные в поля;

#### Класс UserOrderDetails 
Класс отвечает за установку контактных данных для оформления заказа и их валидацию. Является наследником FormDataValid, реализуемым алиесом `CustomerOrder`. Наследует метод `render`, контейнер DOM-элемента формы и инстант брокера событий.
- `constructor(container: HTMLFormElement, protected events: IEvents)` - конструктор принимает DOM-элемент формы, наследуемый от родителя, и инстант брокера событий, для отслеживания валидности полей. Так же он устанавливает слушатели на выбор способа оплаты, при нажатии на кнопку. 

Поля класса: 
- paymentCard: HTMLButtonElement - DOM-элемент для выбора способа оплаты картой.
- paymentCash: HTMLButtonElement - DOM-элемент для выбора способа оплаты наличными.

Методы класса:
- disableButtons( ) - отключает кнопки выбора способа оплаты;

#### Класс OrderSuccess
Класс отвечает за отображение сообщения об успешном оформлении заказа. Наследует класс Component, реализуемый интерфейсом `ISuccess`, с методом `render`. Конструктор класса принимает наследуемый контейнер и действие на клик, реализуемое интерфейсом `IOrderSuccess` и устанавливает слушатель на кнопку закрытия модального окна.
- `constructor(protected container: HTMLFormElement, action?: IOrderSuccess)`

Поля класса:
- _total: HTMLElement - DOM-элемент для отображения суммы списания синапсов;
- _closeButton: HTMLButtonElement - DOM-элемент кнопки закрытия модального окна.

Методы класса:
- set total(value: number) - устанавливает сумму списания синапсов;

#### Класс CardProduct
Отвечает за отображение карточки, задавая в карточке данные категории, названия, изображения, описания и цены. А так же данные кнопок карточки:  Класс используется для отображения карточек на странице сайта. В конструктор класса передается DOM-элемент темплейта, что позволяет, при необходимости, формировать карточки разных вариантов верстки. Также класс полностью наследует методы `render`, `setText` и `setImage` от класса Component. Класс имеет наследников для отображение карточек в каталоге страницы `CardItem` и в отдельном модальном окне `CardItemPreview`.\

- `constructor(protected container: HTMLElement, actions?: ICardActions)` - конструктор принимает контейнер и действие на клик, реализуемое интерфейсом `ICardActions`.

Поля класса содержат элементы разметки элементов карточки:
- cardText: HTMLElement - DOM-элемент текста карточки;
- cardButton: HTMLButtonElement - DOM-элемент кнопки карточки;
- cardCategory: HTMLSpanElement - DOM-элемент категории карточки;
- cardPrice: HTMLSpanElement - DOM-элемент цены карточки;
- cardTitle: HTMLTitleElement - DOM-элемент названия карточки;
- cardImage: HTMLImageElement - DOM-элемент изображения карточки;
- categoryColor: new Map<string, string> - объект с цветами категорий. Ключ - название категории. Значение - цвет категории.

Методы:
- сеттеры и геттеры всех свойств объекта карточки, чтобы иметь возможность изменять только часть данных карточки, без траты ресурсов браузера и гаджетов;
- сеттер и геттер id устанавливает или возвращает уникальный идентификатор карточки.

#### Класс CardItem
Класс отвечает за отображение карточки в каталоге страницы. Класс наследует конструктор от родительского класса `CardProduct`.

#### Класс CardItemPreview
Класс отвечает за отображение карточки в модальном окне. Класс наследует конструктор от родительского класса `CardProduct`.

Поля класса:
- description: HTMLElement - DOM-элемент для отображения описания карточки;

Методы класса: 
- сеттер description(value: string) - задает описание карточки;

#### Класс HomePage
Отвечает за отображение блока с карточками на главной странице и обновление счетика карточек в корзине header страницы. Класс полностью наследует метод `render` от класса Component, реализуемый интерфейсом `IHomePage`, который добавляет карточку на страницу. Конструктор вешает обработчик на нажатие кнопки корзины.
- `constructor(container: HTMLElement, protected events: IEvents)` - конструктор принимает DOM-элемент для отображения карточек, наследуемый от родителя, и инстант брокера событий.

Поля класса: 
- catalogProducts: HTMLElement - DOM-элемент для отображения карточек;
- counterProducts: HTMLElement - DOM-элемент для отображения количества карточек, добавленных в корзину;
- wrapperContainer: HTMLElement - DOM-элемент для установки/удаления блокировщика сролла страницы при сабмите карточки;
- basketButton: HTMLButtonElement - DOM-элемент кнопки открытия корзины;

Методы класса:
- сеттер counterProducts(value: number) - устанавливает счетчик карточек в корзине;
- catalogProducts(items: HTMLElement[ ]) - выводит список карточек на страницу;
- lockedScroll(value: boolean) - блокирует/разблокирует сролл страницы при открытии/закрытии модального окна.

#### Класс Basket
Класс отвечает за формирование шаблона корзины и установку данных в ее темплейт, устанавливает слушатель на кнопку сабмит в корзине. Является наследником класса Component, реализуемый интерфейсом `iBasket`.
- `constructor(container: HTMLElement,  protected events: IEvents)` - конструктор, в качестве параметра наследует DOM-элемент корзины от родителя и экземпляр `EventEmitter` для управления событиями.

Поля класса:
- _listItems: HTMLElement - DOM-элемент для отображения карточек в корзине;
- _totalPrice: HTMLElement - DOM-элемент для отображения общей стоимость карточек в корзине;
- _buttonSubmit: HTMLButtonElement - DOM-элемент кнопки сабмита в корзине;

Методы класса:
- сеттер totalCost() и items() - устанавливает общую стоимость и выводит список карточек в корзину, соответственно;
- disableButton() - блокирует кнопку сабмита в корзине;
- updateIndex() - обновляет индекс каждойкарточки в корзине.

#### Класс ItemBasket
Класс отвечает за отображение карточки в корзине и устанавливает ее данные. Является наследником класса Component, реализуемый интерфейсом `IProductBasket`. 
- `constructor(container: HTMLElement, actions?: IItemBasketActions)` - конструктор, в качестве параметра наследует DOM-элемент карточки и принимает действие на клик, реализуемое интерфейсом `IItemBasketActions`. Устанавливает слушатель на кнопку удаления карточки.

Поля класса:
- _indexItem: HTMLElement - DOM-элемент для отображения индекса карточки в корзине;
- _titleItem: HTMLElement - DOM-элемент для отображения названия карточки в корзине;
- _priceItem: HTMLElement - DOM-элемент для отображения цены карточки в корзине;
- _buttonItem: HTMLButtonElement - DOM-элемент кнопки удаления карточки в корзине;

Методы класса:
- сеттер title(value: string) - устанавливает название карточки в корзине;
- сеттер index(value: number) - устанавливает индекс карточки в корзине;
- сеттер price(value: number) - устанавливает цену карточки в корзине;

### Слой коммуникации 

#### Класс AppApi 
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкенд сервисом.
- `constructor(baseApi: IApi)`

Поля класса:
- _baseApi: IApi - экземпляр Api;

Методы:
- getProducts() - получает список карточек;
- postOrder(order: ICustomer) - создает заказ;

## Взаимодействие компонентов с пользовательским интерфейсом 
Код, описающий взаимодействие представления и данных между собой, находится в файле `index.ts`, выполняющем роль презентора.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*
*События изменения данных (генерируются классами моделей данных)*:
- `cards:change` - изменения массива карточек при выводе их на страницу;
- `card:select` - изменение данных открываемой карточки в модальном окне, карточка выбрана;

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление):*
- `modal:open` - вызывается при открытие модального окна;
- `modal:close` - вызывается при закрытие модального окна;
- `basket:open` - вызывается при открытии модального окна корзины;
- `basket:delete` - вызывается при удалении карточки из корзины;
- `basket:submit` - инициируется при клике на кнопку "оформить" в корзине и открывает окно с формой для заполнения адреса и способа оплаты;
- `card:toBasket` - вызывается при добавлении карточки в корзину;
- `cardInBasket:change` - вызывается при изменении содержимого корзины;
- `orderInput:change` - инициируется при вводе данных в форму Order и  Contacts, после чего начинает процесс валидации формы;
- `orderFormErrors:change` - инициируется вместе с `orderInput:change` на шаге order, происходит валидация и возвращение ошибок формы (или пустого массива, при их отсутствии);
- `contactsFormErrors:change` - инициируется вместе с `orderInput:change` на шаге contacts, происходит валидация и возвращение ошибок формы (или пустого массива, при их отсутствии);
- `order:ready` - инициируется при успешной валидации поля на шаге order и возвращает данные, реализуемые интерфейсом `ICustomer`;
- `contacts:ready` - инициируется при успешной валидации поля на шаге contacts и возвращает данные, реализуемые интерфейсом `ICustomer`;
- `order:submit` -  инициируется при нажатии на кнопку "Далее" на первом шаге оформления заказа;
- `contacts:submit` - инициируется при нажатии на кнопку "Оплатить" на втором шаге оформления заказа;
- `order:success` - инициируется при успешном ответе сервера при оплате товара, после чего открывается модальное окно успешной оплаты.